C51 COMPILER V9.55   MAIN                                                                  05/29/2025 08:22:28 PAGE 1   


C51 COMPILER V9.55, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(..\user;..\lib) DEBUG OBJEC
                    -TEXTEND

line level    source

   1          #include "stc15.h"
   2          
   3          /* ÊýÂë¹ÜÏÔÊ¾µÄÊý×Ö */
   4          unsigned char xdata nums[10] = {0xC0, 0xF9, 0xA4, 0xB0, 0x99, 0x92, 0x82, 0xF8, 0x80, 0x90}; // 0-9£¬¹²Ñô¼
             -«¶ÎÂë±í
   5          
   6          /* ´æ´¢Êý×Ö */
   7          unsigned char DigitBuffer[4]; // ÓÃÓÚ´æ´¢4Î»Êý×ÖµÄÃ¿Ò»Î»
   8          unsigned char DigitReady = 0; // ÊÇ·ñ×¼±¸ºÃÏÔÊ¾Êý×Ö
   9          
  10          /* ¶¨Ê±Ïà¹Ø */
  11          unsigned char count_5ms = 0;
  12          unsigned char count_20ms = 0;
  13          bit task_5ms = 0;
  14          bit task_20ms = 0;
  15          unsigned char count_1s = 0;     // ÓÃÓÚ1Ãë¼ÆÊý
  16          unsigned char timer_running = 0; // ¼ÆÊ±Æ÷ÔËÐÐ×´Ì¬
  17          unsigned int seconds = 0;       // ×ÜÃëÊý£¨0-9999£©
  18          
  19          /* ´®¿Ú·¢ËÍÏà¹Ø */
  20          unsigned char TxBuff[4];        // Ö»´æ·Å4Î»Êý×ÖµÄASCIIÂë
  21          unsigned char TxIndex = 0;
  22          unsigned char TxLen = 4;
  23          unsigned char TxBusy = 0;    //·ÀÖ¹ÖØ¸´·¢ËÍ
  24          
  25          /* Õ¹Ê¾Î» */
  26          unsigned char pos = 0;
  27          
  28          // °´¼ü¶¨Òå£¨ÐÞ¸ÄÎªP1.2-P1.4£©
  29          #define K1 (P1 & 0x04)  // P1.2
  30          #define K2 (P1 & 0x08)  // P1.3 
  31          #define K3 (P1 & 0x10)  // P1.4
  32          
  33          //°´¼ü×´Ì¬
  34          bit key1_pressed = 0;
  35          bit key2_pressed = 0;
  36          bit key3_pressed = 0;
  37          
  38          void timer0_init(void) // 5ºÁÃë@11.0592MHz
  39          {
  40   1          AUXR &= 0x7F; // ¶¨Ê±Æ÷Ê±ÖÓ12TÄ£Ê½
  41   1          TMOD &= 0xF0; // ÉèÖÃ¶¨Ê±Æ÷Ä£Ê½
  42   1          TL0 = 0x00;   // ÉèÖÃ¶¨Ê±³õÊ¼Öµ
  43   1          TH0 = 0xEE;   // ÉèÖÃ¶¨Ê±³õÊ¼Öµ
  44   1          TF0 = 0;      // Çå³ýTF0±êÖ¾
  45   1          TR0 = 1;      // ¶¨Ê±Æ÷0¿ªÊ¼¼ÆÊ±
  46   1          ET0 = 1;      // ÔÊÐí¶¨Ê±Æ÷ÖÐ¶Ï
  47   1      }
  48          
  49          void timer0_inter_handler(void) interrupt 1
  50          {
  51   1          /* 5ms¶¨Ê± ÓÃÓÚË¢ÐÂÊýÂë¹Ü*/
  52   1          task_5ms = 1;
  53   1          count_5ms++;
C51 COMPILER V9.55   MAIN                                                                  05/29/2025 08:22:28 PAGE 2   

  54   1          
  55   1          /* 20ms¶¨Ê± ÓÃÓÚ¼ì²â°´¼ü*/
  56   1          if(++count_20ms >= 4) // 4*5ms=20ms
  57   1          {
  58   2              count_20ms = 0;
  59   2              task_20ms = 1;
  60   2          }
  61   1          
  62   1          /* 1s¶¨Ê± ÓÃÓÚ·¢ËÍÊý¾Ý£¬Ö»ÓÐÕýÔÚ¼ÆÊ±µÄÊ±ºò²Å¿ªÊ¼¼Æ1s*/
  63   1          if(count_5ms >= 200 && timer_running) // 200*5ms=1s
  64   1          {
  65   2              count_5ms = 0;
  66   2              count_1s = 1;
  67   2          }
  68   1      }
  69          
  70          void DisplayDigits()
  71          {
  72   1          // ¶ÎÑ¡ - ËÍ³ö¹²Ñô¼«¶ÎÂë£¨µÍµçÆ½ÁÁ£©
  73   1          P0 = nums[DigitBuffer[pos]];
  74   1      
  75   1          // Çå³ýËùÓÐÎ»Ñ¡£¨Ï¨ÃðËùÓÐÊýÂë¹Ü£©
  76   1          P41 = 1;
  77   1          P42 = 1;
  78   1          P43 = 1;
  79   1          P44 = 1;
  80   1      
  81   1          // Î»Ñ¡£¨ÄÄ¸öÊýÂë¹ÜÏÔÊ¾£©
  82   1          switch (pos)
  83   1          {
  84   2          case 0: P41 = 0; break; // µÚ1Î»
  85   2          case 1: P42 = 0; break; // µÚ2Î»
  86   2          case 2: P43 = 0; break; // µÚ3Î»
  87   2          case 3: P44 = 0; break; // µÚ4Î»
  88   2          }
  89   1      
  90   1          // ×¼±¸ÏÂ´ÎÏÔÊ¾ÏÂÒ»Î»
  91   1          pos++;
  92   1          if (pos >= 4)
  93   1              pos = 0;
  94   1      }
  95          
  96          // ¸üÐÂÊýÂë¹ÜÏÔÊ¾ºÍ´®¿Ú·¢ËÍ»º³åÇø
  97          void UpdateTimeData()
  98          {
  99   1          // ¸üÐÂÊýÂë¹ÜÏÔÊ¾Êý¾Ý
 100   1          DigitBuffer[0] = seconds / 1000 % 10; // Ç§Î»
 101   1          DigitBuffer[1] = seconds / 100 % 10;  // °ÙÎ»
 102   1          DigitBuffer[2] = seconds / 10 % 10;   // Ê®Î»
 103   1          DigitBuffer[3] = seconds % 10;        // ¸öÎ»
 104   1          DigitReady = 1;
 105   1      
 106   1          // ¸üÐÂ´®¿Ú·¢ËÍ»º³åÇø£¨½ö4Î»Êý×Ö£©
 107   1          TxBuff[0] = DigitBuffer[0] + '0'; // Ç§Î»
 108   1          TxBuff[1] = DigitBuffer[1] + '0'; // °ÙÎ»
 109   1          TxBuff[2] = DigitBuffer[2] + '0'; // Ê®Î»
 110   1          TxBuff[3] = DigitBuffer[3] + '0'; // ¸öÎ»
 111   1      }
 112          
 113          // ¿ªÊ¼´®¿Ú·¢ËÍ£¨·¢ËÍ4Î»Êý×Ö£©
 114          void StartUartSend()
 115          {
C51 COMPILER V9.55   MAIN                                                                  05/29/2025 08:22:28 PAGE 3   

 116   1          if (!TxBusy)
 117   1          {
 118   2              TxIndex = 0;
 119   2              TxBusy = 1;
 120   2              SBUF = TxBuff[TxIndex++]; // ·¢ËÍµÚÒ»¸öÊý×Ö
 121   2          }
 122   1      }
 123          
 124          void main()
 125          {
 126   1          /* IO¼Ä´æÆ÷³õÊ¼»¯ */
 127   1          P2M0 = 0xff;
 128   1          P2M1 = 0x00;
 129   1          P4M0 = 0xff; // ½«P4¿ÚÉèÖÃÎªÍÆÍìÊä³ö
 130   1          P4M1 = 0x00;
 131   1          P0M0 = 0xff; // ½«P0¿ÚÉèÖÃÎªÍÆÍìÊä³ö
 132   1          P0M1 = 0x00;
 133   1          
 134   1          // ÉèÖÃP1.2-P1.4ÎªÊäÈëÄ£Ê½£¨×¼Ë«Ïò¿Ú£©
 135   1          P1M0 &= ~0x1C; // P1.2-P1.4
 136   1          P1M1 &= ~0x1C;
 137   1      
 138   1          /* ´®¿Ú¼Ä´æÆ÷³õÊ¼»¯ */
 139   1          SCON = 0x50;  // 8Î»Êý¾Ý,¿É±ä²¨ÌØÂÊ
 140   1          AUXR |= 0x40; // ¶¨Ê±Æ÷Ê±ÖÓ1TÄ£Ê½
 141   1          AUXR &= 0xFE; // ´®¿Ú1Ñ¡Ôñ¶¨Ê±Æ÷1Îª²¨ÌØÂÊ·¢ÉúÆ÷
 142   1          TMOD &= 0x0F; // ÉèÖÃ¶¨Ê±Æ÷Ä£Ê½
 143   1          TL1 = 0xE0;   // ÉèÖÃ¶¨Ê±³õÊ¼Öµ£¬9600bps
 144   1          TH1 = 0xFE;   // ÉèÖÃ¶¨Ê±³õÊ¼Öµ£¬f=11.0592MHz
 145   1          ET1 = 0;      // ½ûÖ¹¶¨Ê±Æ÷1ÖÐ¶Ï
 146   1          ES = 1;       // ÔÊÐí´®¿Ú1ÖÐ¶Ï
 147   1          TR1 = 1;      // ¶¨Ê±Æ÷1¿ªÊ¼¼ÆÊ±
 148   1      
 149   1          timer0_init(); // ¶¨Ê±Æ÷0³õÊ¼»¯
 150   1      
 151   1          EA = 1; // ¿ªÈ«¾ÖÖÐ¶Ï
 152   1      
 153   1          // ³õÊ¼ÏÔÊ¾0000
 154   1          UpdateTimeData();
 155   1      
 156   1          while (1)
 157   1          {
 158   2              if (task_5ms)
 159   2              {
 160   3                  task_5ms = 0;
 161   3                  if (DigitReady)
 162   3                  {
 163   4                      DisplayDigits(); // Ã¿5msË¢ÐÂÒ»´ÎÊýÂë¹Ü
 164   4                  }
 165   3              }
 166   2      
 167   2              if (task_20ms)
 168   2              {
 169   3                  task_20ms = 0;
 170   3                  // °´¼ü¼ì²â£¨20ms¼ì²âÒ»´Î£©
 171   3                  if (K1 == 0) // P1.2°´ÏÂ£¨µÍµçÆ½ÓÐÐ§£©
 172   3                  {
 173   4                      if(!key1_pressed) key1_pressed=1;   //»ù±¾·À¶¶
 174   4                  }
 175   3                  else
 176   3                  {
 177   4                      if(key1_pressed){
C51 COMPILER V9.55   MAIN                                                                  05/29/2025 08:22:28 PAGE 4   

 178   5                          key1_pressed=0;
 179   5                          timer_running = 1; // ¿ªÊ¼¼ÆÊ±
 180   5                      }
 181   4                  }
 182   3                  if (K2 == 0) // P1.3°´ÏÂ
 183   3                  {
 184   4                      if(!key2_pressed) key2_pressed=1;
 185   4                  }
 186   3                  else
 187   3                  {
 188   4                      if(key2_pressed){
 189   5                          key2_pressed=0;
 190   5                          timer_running = 0; // ÔÝÍ£¼ÆÊ±
 191   5                      }
 192   4                  }
 193   3                  if (K3 == 0) // P1.4°´ÏÂ
 194   3                  {
 195   4                      if(!key3_pressed) key3_pressed=1;
 196   4                  }
 197   3                  else
 198   3                  {
 199   4                      if(key3_pressed){
 200   5                          key3_pressed=0;
 201   5                          seconds = 0;          // ÇåÁã
 202   5                          timer_running = 0;    // ÔÝÍ£¼ÆÊ±
 203   5                          UpdateTimeData();     // ¸üÐÂÏÔÊ¾Êý¾Ý
 204   5                          StartUartSend();      // ·¢ËÍÇåÁãºóµÄÊ±¼ä
 205   5                      }
 206   4                  }
 207   3              }
 208   2      
 209   2              if (count_1s && timer_running)
 210   2              {
 211   3                  count_1s = 0;
 212   3                  seconds++;             // ÃëÊýÔö¼Ó
 213   3                  if (seconds > 9999)    // ·ÀÖ¹Òç³ö
 214   3                      seconds = 0;
 215   3                  UpdateTimeData();       // ¸üÐÂÏÔÊ¾Êý¾Ý
 216   3                  StartUartSend();       // ·¢ËÍµ±Ç°Ê±¼ä
 217   3              }
 218   2          }
 219   1      }
 220          
 221          void Uart_Int(void) interrupt 4
 222          {
 223   1          if (RI)
 224   1          {
 225   2              RI = 0; // Çå³ý½ÓÊÕÖÐ¶Ï±êÖ¾
 226   2          }
 227   1      
 228   1          if (TI)
 229   1          {
 230   2              TI = 0; // Çå³ý·¢ËÍÖÐ¶Ï±êÖ¾
 231   2              if (TxBusy && TxIndex < TxLen)
 232   2              {
 233   3                  SBUF = TxBuff[TxIndex++]; // ·¢ËÍÏÂÒ»¸öÊý×Ö
 234   3              }
 235   2              else
 236   2              {
 237   3                  TxBusy = 0; // ·¢ËÍÍê³É
 238   3              }
 239   2          }
C51 COMPILER V9.55   MAIN                                                                  05/29/2025 08:22:28 PAGE 5   

 240   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    618    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     29    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      5    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
